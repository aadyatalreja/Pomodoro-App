<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pomodoro Timer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ---- Theme: CSS variables ---- */
    :root {
      --bg-body: linear-gradient(160deg, #e8f4f8 0%, #f0ebe6 50%, #f5f0eb 100%);
      --bg-card: rgba(255, 255, 255, 0.82);
      --bg-card-border: rgba(255, 255, 255, 0.6);
      --text-primary: #1a1a1a;
      --text-secondary: #555;
      --text-muted: #424242;
      --text-muted-strong: #616161;
      --border-subtle: rgba(0, 0, 0, 0.06);
      --border-input: rgba(0, 0, 0, 0.12);
      --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.06), 0 2px 8px rgba(0, 0, 0, 0.04);
      --shadow-focus: 0 12px 48px rgba(46, 125, 50, 0.18);
      --input-bg: #fff;
      --input-bg-disabled: #f5f5f5;
      --btn-secondary-bg: rgba(0, 0, 0, 0.06);
      --btn-secondary-border: rgba(0, 0, 0, 0.08);
      --progress-track: rgba(0, 0, 0, 0.06);
      --todo-bg: rgba(0, 0, 0, 0.02);
      --todo-item-hover: rgba(0, 0, 0, 0.04);
      --todo-done: #757575;
      --focus-ring: #2e7d32;
    }
    [data-theme="dark"] {
      --bg-body: linear-gradient(160deg, #1a1d24 0%, #252830 50%, #1e2128 100%);
      --bg-card: rgba(40, 44, 52, 0.9);
      --bg-card-border: rgba(255, 255, 255, 0.08);
      --text-primary: #e8e8e8;
      --text-secondary: #b0b0b0;
      --text-muted: #9e9e9e;
      --text-muted-strong: #b0b0b0;
      --border-subtle: rgba(255, 255, 255, 0.08);
      --border-input: rgba(255, 255, 255, 0.15);
      --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.3), 0 2px 8px rgba(0, 0, 0, 0.2);
      --shadow-focus: 0 12px 48px rgba(46, 125, 50, 0.25);
      --input-bg: rgba(255, 255, 255, 0.08);
      --input-bg-disabled: rgba(255, 255, 255, 0.04);
      --btn-secondary-bg: rgba(255, 255, 255, 0.08);
      --btn-secondary-border: rgba(255, 255, 255, 0.12);
      --progress-track: rgba(255, 255, 255, 0.1);
      --todo-bg: rgba(255, 255, 255, 0.04);
      --todo-item-hover: rgba(255, 255, 255, 0.08);
      --todo-done: #7a7a7a;
      --focus-ring: #66bb6a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-body);
      padding: 1rem;
      transition: background 0.35s ease;
    }
    .app-layout {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: flex-start;
      justify-content: center;
      max-width: 900px;
    }
    .card {
      background: var(--bg-card);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      padding: 2.25rem;
      border-radius: 24px;
      box-shadow: var(--shadow-card);
      text-align: center;
      min-width: 340px;
      max-width: 420px;
      transition: box-shadow 0.4s ease, background 0.35s ease, border-color 0.35s ease;
      border: 1px solid var(--bg-card-border);
    }
    .card.state-running { box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08), 0 4px 16px rgba(0, 0, 0, 0.04); }
    .card.state-running.mode-focus { box-shadow: 0 12px 48px rgba(46, 125, 50, 0.18); }
    .card.state-running.mode-shortBreak { box-shadow: 0 12px 48px rgba(0, 150, 136, 0.18); }
    .card.state-running.mode-longBreak { box-shadow: 0 12px 48px rgba(123, 31, 162, 0.18); }
    .card.state-running.mode-custom { box-shadow: 0 12px 48px rgba(46, 125, 50, 0.18); }
    .card.state-paused { box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06); }
    .card.state-finished { box-shadow: 0 12px 48px rgba(46, 125, 50, 0.2); }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.25rem;
      gap: 0.5rem;
    }
    h1 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -0.02em;
    }
    .theme-toggle {
      flex-shrink: 0;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 12px;
      background: var(--btn-secondary-bg);
      border: 1px solid var(--btn-secondary-border);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease, transform 0.2s ease;
      color: var(--text-secondary);
    }
    .theme-toggle:hover { background: var(--todo-item-hover); color: var(--text-primary); }
    .theme-toggle:focus-visible { outline: 2px solid var(--focus-ring); outline-offset: 2px; }
    .theme-toggle svg { width: 20px; height: 20px; }
    .theme-toggle .icon-dark { display: none; }
    .theme-toggle .icon-light { display: block; }
    [data-theme="dark"] .theme-toggle .icon-dark { display: block; }
    [data-theme="dark"] .theme-toggle .icon-light { display: none; }

    .presets {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }
    .presets button {
      padding: 0.6rem 1rem;
      min-height: 44px;
      border: 2px solid transparent;
      border-radius: 12px;
      background: var(--btn-secondary-bg);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.25s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    .presets button:hover:not(:disabled) {
      background: var(--todo-item-hover);
      color: var(--text-primary);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .presets button:active:not(:disabled) { transform: scale(0.98); }
    .presets button:focus-visible { outline: 2px solid var(--focus-ring); outline-offset: 2px; }
    .presets button:disabled { opacity: 0.5; cursor: not-allowed; }
    .presets button.active[data-preset="focus"] {
      background: #2e7d32;
      border-color: #2e7d32;
      color: #fff;
    }
    .presets button.active[data-preset="shortBreak"] {
      background: #00897b;
      border-color: #00897b;
      color: #fff;
    }
    .presets button.active[data-preset="longBreak"] {
      background: #7b1fa2;
      border-color: #7b1fa2;
      color: #fff;
    }

    .timer {
      font-size: 4rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
      transition: color 0.35s ease;
      line-height: 1.1;
    }
    .card.state-running.mode-focus .timer { color: #1b5e20; }
    .card.state-running.mode-shortBreak .timer { color: #00695c; }
    .card.state-running.mode-longBreak .timer { color: #4a148c; }
    .card.state-paused .timer { color: var(--text-muted); }
    .card.state-finished .timer { color: #1b5e20; }

    .focusing-on {
      min-height: 1.25rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      transition: color 0.3s ease, opacity 0.3s ease;
    }
    .focusing-on span { font-weight: 500; color: var(--text-primary); }
    .message {
      min-height: 1.75rem;
      font-size: 0.95rem;
      font-weight: 500;
      margin-bottom: 1.25rem;
      transition: color 0.3s ease;
      color: var(--text-secondary);
    }
    .card.state-running.mode-focus .message { color: #2e7d32; }
    .card.state-running.mode-shortBreak .message { color: #00695c; }
    .card.state-running.mode-longBreak .message { color: #4a148c; }
    .card.state-paused .message { color: var(--text-muted-strong); }
    .card.state-finished .message { color: #1b5e20; font-weight: 600; }
    .message.error { color: #b71c1c; }

    .progress-wrap {
      height: 10px;
      background: var(--progress-track);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 1.5rem;
      transition: background 0.35s ease;
    }
    .progress-fill {
      height: 100%;
      width: 100%;
      border-radius: 10px;
      transition: width 1s linear, background 0.35s ease;
    }
    .card.state-idle .progress-fill,
    .card.state-paused .progress-fill { background: #9e9e9e; }
    .card.state-running.mode-focus .progress-fill { background: #2e7d32; }
    .card.state-running.mode-shortBreak .progress-fill { background: #00897b; }
    .card.state-running.mode-longBreak .progress-fill { background: #7b1fa2; }
    .card.state-running.mode-custom .progress-fill { background: #2e7d32; }
    .card.state-finished .progress-fill { background: #2e7d32; }

    .controls {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .controls button {
      padding: 0.75rem 1.5rem;
      min-height: 48px;
      min-width: 100px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s ease;
    }
    .controls button:hover:not(:disabled) { transform: translateY(-2px); }
    .controls button:active:not(:disabled) { transform: translateY(0); }
    .controls button:focus-visible { outline: 2px solid var(--focus-ring); outline-offset: 2px; }
    .controls button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-start {
      background: #2e7d32;
      color: #fff;
      box-shadow: 0 4px 14px rgba(46, 125, 50, 0.35);
    }
    .btn-start:hover:not(:disabled) { background: #1b5e20; box-shadow: 0 6px 20px rgba(46, 125, 50, 0.4); }
    .card.state-idle .btn-start { animation: softGlow 2.5s ease-in-out infinite; }
    @keyframes softGlow {
      0%, 100% { box-shadow: 0 4px 14px rgba(46, 125, 50, 0.35); }
      50% { box-shadow: 0 4px 20px rgba(46, 125, 50, 0.5); }
    }
    .btn-pause { background: #757575; color: #fff; }
    .btn-pause:hover:not(:disabled) { background: #616161; }
    .btn-reset {
      background: var(--btn-secondary-bg);
      color: var(--text-muted);
      border: 1px solid var(--btn-secondary-border);
    }
    .btn-reset:hover:not(:disabled) { background: var(--todo-item-hover); color: var(--text-primary); }

    .secondary {
      margin-top: 1.25rem;
      padding-top: 1.25rem;
      border-top: 1px solid var(--border-subtle);
    }
    .secondary-toggle {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      padding: 0.4rem 0;
      margin-bottom: 0.75rem;
      transition: color 0.2s ease;
    }
    .secondary-toggle:hover { color: var(--text-primary); }
    .secondary-toggle:focus-visible { outline: 2px solid var(--focus-ring); outline-offset: 2px; border-radius: 4px; }
    .custom-duration {
      display: none;
      margin-bottom: 1rem;
      padding: 1rem;
      background: var(--todo-bg);
      border-radius: 12px;
    }
    .custom-duration.visible { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .custom-duration label { margin-right: 0.5rem; color: var(--text-muted); font-size: 0.9rem; }
    .custom-duration input {
      width: 4rem;
      padding: 0.5rem;
      border-radius: 8px;
      border: 1px solid var(--border-input);
      font-size: 0.95rem;
      text-align: center;
      background: var(--input-bg);
      color: var(--text-primary);
    }
    .custom-duration input:focus { outline: 2px solid var(--focus-ring); outline-offset: 0; }
    .custom-duration input:disabled { opacity: 0.6; cursor: not-allowed; background: var(--input-bg-disabled); }
    .custom-duration .apply {
      margin-left: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      border-radius: 8px;
      background: var(--btn-secondary-bg);
      border: 1px solid var(--btn-secondary-border);
      cursor: pointer;
      font-weight: 500;
      color: var(--text-muted);
      transition: background 0.2s ease;
    }
    .custom-duration .apply:hover:not(:disabled) { background: var(--todo-item-hover); color: var(--text-primary); }

    /* ---- To-Do box (separate card next to Pomodoro) ---- */
    .todo-box {
      background: var(--bg-card);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      padding: 1.5rem;
      border-radius: 24px;
      box-shadow: var(--shadow-card);
      border: 1px solid var(--bg-card-border);
      min-width: 280px;
      max-width: 340px;
      transition: background 0.35s ease, border-color 0.35s ease;
    }
    .todo-section {
      text-align: left;
    }
    .todo-section h2 {
      margin: 0 0 0.75rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
      letter-spacing: -0.01em;
    }
    .todo-form {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .todo-form input {
      flex: 1;
      min-width: 0;
      padding: 0.5rem 0.75rem;
      border-radius: 10px;
      border: 1px solid var(--border-input);
      font-size: 0.9rem;
      background: var(--input-bg);
      color: var(--text-primary);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .todo-form input::placeholder { color: var(--text-muted); }
    .todo-form input:focus {
      outline: none;
      border-color: var(--focus-ring);
      box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
    }
    .todo-form .btn-add {
      flex-shrink: 0;
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 10px;
      background: #2e7d32;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    .todo-form .btn-add:hover:not(:disabled) { background: #1b5e20; }
    .todo-form .btn-add:focus-visible { outline: 2px solid var(--focus-ring); outline-offset: 2px; }
    .todo-form .btn-add:disabled { opacity: 0.5; cursor: not-allowed; }
    .todo-form .btn-add svg { width: 20px; height: 20px; }
    .todo-list {
      list-style: none;
      margin: 0;
      padding: 0;
      max-height: 180px;
      overflow-y: auto;
      border-radius: 10px;
      background: var(--todo-bg);
    }
    .todo-list:empty::after {
      content: 'No tasks yet';
      display: block;
      padding: 0.75rem;
      font-size: 0.85rem;
      color: var(--text-muted);
      text-align: center;
    }
    .todo-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--border-subtle);
      transition: background 0.2s ease;
      cursor: pointer;
    }
    .todo-item:last-child { border-bottom: none; }
    .todo-item:hover { background: var(--todo-item-hover); }
    .todo-item:focus-visible { outline: 2px solid var(--focus-ring); outline-offset: -2px; }
    .todo-item.done .todo-text {
      text-decoration: line-through;
      color: var(--todo-done);
      transition: color 0.25s ease, text-decoration 0.2s ease;
    }
    .todo-item .todo-check {
      flex-shrink: 0;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-input);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    .todo-item.done .todo-check {
      background: #2e7d32;
      border-color: #2e7d32;
      color: #fff;
    }
    .todo-item .todo-check svg { width: 12px; height: 12px; }
    .todo-item .todo-text {
      flex: 1;
      min-width: 0;
      font-size: 0.9rem;
      color: var(--text-primary);
      word-break: break-word;
    }
    .todo-item .btn-delete {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease, color 0.2s ease;
    }
    .todo-item .btn-delete:hover { background: rgba(183, 28, 28, 0.15); color: #b71c1c; }
    .todo-item .btn-delete:focus-visible { outline: 2px solid #b71c1c; outline-offset: 1px; }
    .todo-item .btn-delete svg { width: 14px; height: 14px; }
    .todo-item .btn-focus {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease, color 0.2s ease;
    }
    .todo-item .btn-focus:hover { background: rgba(46, 125, 50, 0.15); color: #2e7d32; }
    .todo-item.active-task .btn-focus { color: #2e7d32; }
    .todo-item .btn-focus:focus-visible { outline: 2px solid var(--focus-ring); outline-offset: 1px; }
    .todo-item .btn-focus svg { width: 14px; height: 14px; }
    .todo-item.active-task {
      border-left: 3px solid #2e7d32;
      background: var(--todo-item-hover);
      padding-left: calc(0.75rem - 3px);
    }
    .todo-option {
      margin-top: 0.5rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .todo-option label { cursor: pointer; display: inline-flex; align-items: center; gap: 0.35rem; }

    .extras {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-top: 0.75rem;
    }
    .pomodoro-count { font-size: 0.9rem; color: var(--text-secondary); }
    .sound-toggle {
      background: var(--btn-secondary-bg);
      border: 1px solid var(--btn-secondary-border);
      padding: 0.5rem 1rem;
      min-height: 44px;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s ease;
    }
    .sound-toggle:hover { background: var(--todo-item-hover); color: var(--text-primary); }
    .sound-toggle:focus-visible { outline: 2px solid var(--focus-ring); outline-offset: 2px; }
    .sound-toggle.muted { opacity: 0.7; }

    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
  </style>
</head>
<body>
  <div class="app-layout">
  <div class="card state-idle mode-focus" id="card">
    <div class="card-header">
      <h1>Pomodoro Timer</h1>
      <button type="button" class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode" title="Toggle theme">
        <span class="icon-light" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3a6 6 0 0 0 6 6c0 2.2-1.2 4.2-3 5.2V17a1 1 0 0 1-2 0v-2.8C11.2 13.2 10 11.2 10 9a6 6 0 0 0 2-6Z"/><circle cx="12" cy="14" r="4"/></svg></span>
        <span class="icon-dark" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></span>
      </button>
    </div>

    <div class="presets" role="group" aria-label="Session presets">
      <button type="button" class="preset active" data-preset="focus" data-mins="25" aria-pressed="true">Focus (25 min)</button>
      <button type="button" class="preset" data-preset="shortBreak" data-mins="5" aria-pressed="false">Short Break (5 min)</button>
      <button type="button" class="preset" data-preset="longBreak" data-mins="15" aria-pressed="false">Long Break (15 min)</button>
    </div>

    <div class="timer" id="timer" aria-live="polite">25:00</div>
    <div class="focusing-on" id="focusingOn" aria-live="polite" style="display: none;"></div>
    <div class="message" id="message" aria-live="polite"></div>

    <div class="progress-wrap">
      <div class="progress-fill" id="progressBar" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
    </div>

    <div class="controls">
      <button type="button" class="btn-start" id="btnStart" aria-label="Start timer">Start</button>
      <button type="button" class="btn-pause" id="btnPause" aria-label="Pause timer">Pause</button>
      <button type="button" class="btn-reset" id="btnReset" aria-label="Reset timer">Reset</button>
    </div>

    <div class="secondary">
      <button type="button" class="secondary-toggle" id="btnToggleCustom" aria-expanded="false" aria-controls="customDuration">Custom time</button>
      <div class="custom-duration" id="customDuration" role="region" aria-label="Custom duration">
        <label for="customMins">Minutes (1â€“90):</label>
        <input type="number" id="customMins" min="1" max="90" value="25" aria-label="Custom duration in minutes">
        <button type="button" class="apply" id="btnApplyCustom">Apply</button>
      </div>
      <div class="extras">
        <span class="pomodoro-count" id="pomodoroCount">Pomodoros completed: 0</span>
        <button type="button" class="sound-toggle" id="btnSound" aria-pressed="false" aria-label="Mute sound">Sound on</button>
      </div>
    </div>

    <audio id="alarm" preload="auto" aria-hidden="true">
      <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleB0A" type="audio/wav">
    </audio>
  </div>

  <div class="todo-box">
    <section class="todo-section" aria-label="To-do list">
      <h2>To-Do</h2>
      <div class="todo-form">
        <label for="todoInput" class="sr-only">New task</label>
        <input type="text" id="todoInput" placeholder="Add a taskâ€¦" maxlength="200" autocomplete="off">
        <button type="button" class="btn-add" id="todoAdd" aria-label="Add task" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
        </button>
      </div>
      <ul class="todo-list" id="todoList"></ul>
      <div class="todo-option">
        <label><input type="checkbox" id="autoCompleteTask" aria-describedby="autoCompleteDesc"> <span id="autoCompleteDesc">Mark active task complete when focus session ends</span></label>
      </div>
    </section>
  </div>
  </div>

  <script>
    // Theme: restore preference and apply
    (function () {
      var saved = localStorage.getItem('pomodoroTheme');
      var dark = saved === 'dark' || (!saved && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
      document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
    })();

    var remainingSeconds = 25 * 60;
    var totalSeconds = 25 * 60;
    var intervalId = null;
    var isRunning = false;
    var currentPreset = 'focus';
    var soundMuted = false;
    var pomodoroCount = parseInt(localStorage.getItem('pomodoroCount') || '0', 10);

    var card = document.getElementById('card');
    var timerEl = document.getElementById('timer');
    var messageEl = document.getElementById('message');
    var focusingOnEl = document.getElementById('focusingOn');
    var progressBar = document.getElementById('progressBar');
    var customMinsInput = document.getElementById('customMins');
    var customDurationEl = document.getElementById('customDuration');
    var btnToggleCustom = document.getElementById('btnToggleCustom');
    var alarmEl = document.getElementById('alarm');
    var btnSound = document.getElementById('btnSound');

    // To-Do state
    var todos = [];
    var activeTaskId = null;
    var todoStorageKey = 'pomodoroTodos';
    var activeTaskStorageKey = 'pomodoroActiveTask';
    var autoCompleteStorageKey = 'pomodoroAutoComplete';

    var statusCopy = {
      focus: 'Stay focused âœ¨',
      shortBreak: 'Take a short break âœ¨',
      longBreak: 'Relax â€” long break âœ¨',
      custom: 'Session in progress âœ¨',
      paused: 'Paused â€” take a breath',
      finished: 'Great job! Session complete ðŸŽ‰'
    };

    function loadTodos() {
      try {
        var raw = localStorage.getItem(todoStorageKey);
        if (raw) todos = JSON.parse(raw);
        else todos = [];
      } catch (e) { todos = []; }
      try {
        activeTaskId = localStorage.getItem(activeTaskStorageKey);
        if (activeTaskId && !todos.some(function (t) { return t.id === activeTaskId; })) activeTaskId = null;
      } catch (e) { activeTaskId = null; }
      var autoEl = document.getElementById('autoCompleteTask');
      if (autoEl) {
        var ac = localStorage.getItem(autoCompleteStorageKey);
        autoEl.checked = ac === 'true';
      }
    }
    function saveTodos() {
      try {
        localStorage.setItem(todoStorageKey, JSON.stringify(todos));
        if (activeTaskId) localStorage.setItem(activeTaskStorageKey, activeTaskId);
        else localStorage.removeItem(activeTaskStorageKey);
        localStorage.setItem(autoCompleteStorageKey, document.getElementById('autoCompleteTask').checked ? 'true' : 'false');
      } catch (e) {}
    }
    function updateFocusingOn() {
      if (!focusingOnEl) return;
      if (currentPreset === 'focus' && activeTaskId) {
        var t = todos.filter(function (x) { return x.id === activeTaskId; })[0];
        if (t) {
          focusingOnEl.innerHTML = 'Focusing on: <span>' + escapeHtml(t.text) + '</span>';
          focusingOnEl.style.display = '';
          return;
        }
      }
      focusingOnEl.style.display = 'none';
      focusingOnEl.innerHTML = '';
    }
    function escapeHtml(s) {
      var div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }
    function renderTodos() {
      var list = document.getElementById('todoList');
      if (!list) return;
      list.innerHTML = '';
      todos.forEach(function (task) {
        var li = document.createElement('li');
        li.className = 'todo-item' + (task.done ? ' done' : '') + (task.id === activeTaskId ? ' active-task' : '');
        li.setAttribute('data-id', task.id);
        li.setAttribute('tabindex', '0');
        li.setAttribute('role', 'button');
        li.setAttribute('aria-pressed', task.done ? 'true' : 'false');
        li.setAttribute('aria-label', (task.done ? 'Completed: ' : '') + task.text + (task.id === activeTaskId ? ', active focus task' : ''));
        var check = document.createElement('span');
        check.className = 'todo-check';
        check.setAttribute('aria-hidden', 'true');
        check.innerHTML = task.done ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12l5 5L20 7"/></svg>' : '';
        var text = document.createElement('span');
        text.className = 'todo-text';
        text.textContent = task.text;
        var focusBtn = document.createElement('button');
        focusBtn.type = 'button';
        focusBtn.className = 'btn-focus';
        focusBtn.setAttribute('aria-label', task.id === activeTaskId ? 'Active focus task' : 'Set as focus task');
        focusBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l2 2"/></svg>';
        var del = document.createElement('button');
        del.type = 'button';
        del.className = 'btn-delete';
        del.setAttribute('aria-label', 'Delete task');
        del.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 6l12 12M6 18L18 6"/></svg>';
        li.appendChild(check);
        li.appendChild(text);
        li.appendChild(focusBtn);
        li.appendChild(del);
        list.appendChild(li);
      });
      updateFocusingOn();
    }
    function addTodo() {
      var input = document.getElementById('todoInput');
      if (!input) return;
      var text = input.value.trim();
      if (!text) return;
      var id = 't' + Date.now() + '-' + Math.random().toString(36).slice(2, 9);
      todos.push({ id: id, text: text, done: false });
      input.value = '';
      document.getElementById('todoAdd').disabled = true;
      saveTodos();
      renderTodos();
      input.focus();
    }
    function toggleTodo(id) {
      var t = todos.filter(function (x) { return x.id === id; })[0];
      if (!t) return;
      t.done = !t.done;
      saveTodos();
      renderTodos();
    }
    function deleteTodo(id, ev) {
      if (ev) ev.stopPropagation();
      todos = todos.filter(function (x) { return x.id !== id; });
      if (activeTaskId === id) activeTaskId = null;
      saveTodos();
      renderTodos();
      updateFocusingOn();
    }
    function setActiveTask(id) {
      activeTaskId = id === activeTaskId ? null : id;
      saveTodos();
      renderTodos();
      updateFocusingOn();
    }

    function setUIState(state) {
      card.className = card.className.replace(/\s*state-\w+/g, '') + ' state-' + state;
    }

    function setMode(mode) {
      card.className = card.className.replace(/\s*mode-\w+/g, '') + ' mode-' + (mode || 'focus');
    }

    function formatTime(sec) {
      var m = Math.floor(sec / 60);
      var s = sec % 60;
      return (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
    }

    function updateDisplay() {
      timerEl.textContent = formatTime(remainingSeconds);
      var pct = totalSeconds > 0 ? Math.max(0, (remainingSeconds / totalSeconds) * 100) : 0;
      progressBar.style.width = pct + '%';
      progressBar.setAttribute('aria-valuenow', Math.round(pct));
    }

    function updatePomodoroCount() {
      document.getElementById('pomodoroCount').textContent = 'Pomodoros completed: ' + pomodoroCount;
      try { localStorage.setItem('pomodoroCount', String(pomodoroCount)); } catch (e) {}
    }

    function setPresetActive(preset) {
      document.querySelectorAll('.preset').forEach(function (btn) {
        var isActive = btn.getAttribute('data-preset') === preset;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
    }

    function setDuration(mins, preset) {
      if (preset !== undefined) currentPreset = preset;
      mins = Math.max(1, Math.min(90, mins));
      totalSeconds = mins * 60;
      remainingSeconds = totalSeconds;
      customMinsInput.value = mins;
      setMode(currentPreset === 'custom' ? 'custom' : currentPreset);
      updateDisplay();
    }

    function tick() {
      if (remainingSeconds <= 0) {
        clearInterval(intervalId);
        intervalId = null;
        isRunning = false;
        setUIState('finished');
        setMode(currentPreset === 'custom' ? 'custom' : currentPreset);
        setControlsDisabled(false);
        messageEl.textContent = statusCopy.finished;
        messageEl.classList.remove('error');
        if (currentPreset === 'focus') {
          pomodoroCount++;
          updatePomodoroCount();
          var autoEl = document.getElementById('autoCompleteTask');
          if (autoEl && autoEl.checked && activeTaskId) {
            var t = todos.filter(function (x) { return x.id === activeTaskId; })[0];
            if (t && !t.done) {
              t.done = true;
              saveTodos();
              renderTodos();
            }
          }
        }
        updateFocusingOn();
        if (!soundMuted) {
          try { alarmEl.currentTime = 0; alarmEl.play(); } catch (e) {}
        }
        return;
      }
      remainingSeconds--;
      updateDisplay();
    }

    function setControlsDisabled(disabled) {
      document.querySelectorAll('.preset').forEach(function (b) { b.disabled = disabled; });
      customMinsInput.disabled = disabled;
      document.getElementById('btnApplyCustom').disabled = disabled;
    }

    function startTimer() {
      if (isRunning) return;
      isRunning = true;
      setUIState('running');
      setMode(currentPreset === 'custom' ? 'custom' : currentPreset);
      setControlsDisabled(true);
      messageEl.textContent = statusCopy[currentPreset] || statusCopy.custom;
      messageEl.classList.remove('error');
      updateFocusingOn();
      if (intervalId) clearInterval(intervalId);
      intervalId = setInterval(tick, 1000);
    }

    function pauseTimer() {
      if (!isRunning) return;
      isRunning = false;
      setUIState('paused');
      setControlsDisabled(false);
      if (intervalId) { clearInterval(intervalId); intervalId = null; }
      messageEl.textContent = statusCopy.paused;
      messageEl.classList.remove('error');
    }

    function resetTimer() {
      if (intervalId) { clearInterval(intervalId); intervalId = null; }
      isRunning = false;
      setUIState('idle');
      setMode(currentPreset === 'custom' ? 'custom' : currentPreset);
      setControlsDisabled(false);
      var mins = parseInt(customMinsInput.value, 10) || 25;
      mins = Math.max(1, Math.min(90, mins));
      setDuration(mins, currentPreset);
      messageEl.textContent = '';
      messageEl.classList.remove('error');
    }

    function applyPreset(mins, preset) {
      if (isRunning) return;
      setDuration(mins, preset);
      setPresetActive(preset);
      messageEl.textContent = '';
      messageEl.classList.remove('error');
      updateFocusingOn();
    }

    function applyCustomDuration() {
      if (isRunning) return;
      var raw = customMinsInput.value.trim();
      var mins = parseInt(raw, 10);
      if (raw === '' || isNaN(mins) || mins < 1 || mins > 90) {
        messageEl.textContent = 'Please enter 1â€“90 minutes';
        messageEl.classList.add('error');
        return;
      }
      setDuration(mins, 'custom');
      setPresetActive(null);
      messageEl.textContent = '';
      messageEl.classList.remove('error');
      updateFocusingOn();
    }

    // Theme toggle
    document.getElementById('themeToggle').addEventListener('click', function () {
      var root = document.documentElement;
      var isDark = root.getAttribute('data-theme') === 'dark';
      root.setAttribute('data-theme', isDark ? 'light' : 'dark');
      try { localStorage.setItem('pomodoroTheme', isDark ? 'light' : 'dark'); } catch (e) {}
      this.setAttribute('aria-label', isDark ? 'Toggle light mode' : 'Toggle dark mode');
    });

    btnToggleCustom.addEventListener('click', function () {
      var open = customDurationEl.classList.toggle('visible');
      btnToggleCustom.setAttribute('aria-expanded', open ? 'true' : 'false');
      btnToggleCustom.textContent = open ? 'Hide custom time' : 'Custom time';
    });

    document.querySelectorAll('.preset').forEach(function (btn) {
      btn.addEventListener('click', function () {
        if (btn.disabled) return;
        applyPreset(parseInt(btn.getAttribute('data-mins'), 10), btn.getAttribute('data-preset'));
      });
    });

    document.getElementById('btnStart').addEventListener('click', startTimer);
    document.getElementById('btnPause').addEventListener('click', pauseTimer);
    document.getElementById('btnReset').addEventListener('click', resetTimer);
    document.getElementById('btnApplyCustom').addEventListener('click', applyCustomDuration);

    customMinsInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') applyCustomDuration();
    });

    btnSound.addEventListener('click', function () {
      soundMuted = !soundMuted;
      btnSound.classList.toggle('muted', soundMuted);
      btnSound.setAttribute('aria-pressed', soundMuted ? 'true' : 'false');
      btnSound.textContent = soundMuted ? 'Sound off' : 'Sound on';
    });

    document.addEventListener('keydown', function (e) {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      if (e.code === 'Space') {
        e.preventDefault();
        if (isRunning) pauseTimer(); else startTimer();
      } else if (e.code === 'KeyR') {
        e.preventDefault();
        resetTimer();
      }
    });

    // To-Do: load, render, and wire
    loadTodos();
    renderTodos();
    var todoInput = document.getElementById('todoInput');
    var todoAddBtn = document.getElementById('todoAdd');
    todoInput.addEventListener('input', function () {
      todoAddBtn.disabled = !this.value.trim();
    });
    todoInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (this.value.trim()) addTodo();
      }
    });
    todoAddBtn.addEventListener('click', addTodo);
    document.getElementById('todoList').addEventListener('click', function (e) {
      var item = e.target.closest('.todo-item');
      if (!item) return;
      var id = item.getAttribute('data-id');
      if (e.target.closest('.btn-delete')) {
        deleteTodo(id, e);
        return;
      }
      if (e.target.closest('.btn-focus')) {
        setActiveTask(id);
        return;
      }
      toggleTodo(id);
    });
    document.getElementById('todoList').addEventListener('keydown', function (e) {
      var item = e.target.closest('.todo-item');
      if (!item) return;
      var id = item.getAttribute('data-id');
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        if (e.target.closest('.btn-delete')) deleteTodo(id, e);
        else if (e.target.closest('.btn-focus')) setActiveTask(id);
        else toggleTodo(id);
      }
    });
    document.getElementById('autoCompleteTask').addEventListener('change', saveTodos);

    updateDisplay();
    updatePomodoroCount();
    var themeBtn = document.getElementById('themeToggle');
    if (themeBtn) themeBtn.setAttribute('aria-label', document.documentElement.getAttribute('data-theme') === 'dark' ? 'Toggle light mode' : 'Toggle dark mode');
  </script>
</body>
</html>
